# Pnpm Detection

## Requirements

Pnpm detection relies on the presence of lockfiles generated by the pnpm package manager. The detector searches for the following files:

- `pnpm-lock.yaml`
- `shrinkwrap.yaml` (legacy format)

The detector supports lockfile versions 5, 6, and 9, with version 9 being the maximum supported version.

## Detection strategy

Pnpm detection is performed by parsing lockfiles found in the scan directory. The `PnpmComponentDetectorFactory` acts as a version-aware factory that:

1. **Detects the lockfile version** by parsing the `lockfileVersion` field in the YAML file
2. **Delegates to the appropriate version-specific detector**:
   - `Pnpm5Detector` for lockfile version 5.x (also handles legacy `shrinkwrapVersion` files)
   - `Pnpm6Detector` for lockfile version 6.x
   - `Pnpm9Detector` for lockfile version 9.x

Each version-specific detector handles the format differences in pnpm lockfiles:

- **Version 5**: Basic package graph with dependencies listed in the `packages` section
- **Version 6**: Introduced workspace support with `importers` section and improved dependency tracking
- **Version 9**: Changed the structure to use `snapshots` instead of `packages` and removed dev dependency metadata from the lockfile

### Dependency Graph Construction

The detectors build a complete dependency graph by:

1. Registering all packages found in the lockfile as components
2. Creating parent-child relationships based on dependency declarations
3. Marking direct dependencies as explicit references
4. Identifying development dependencies based on:
   - Lockfile metadata (versions 5-6)
   - Dependency tree position (version 9, where lockfile no longer includes dev dependency flags)

### Workspace Support

Pnpm supports both single-package projects ("dedicated shrinkwrap") and multi-package workspaces ("shared shrinkwrap"). The detectors handle both scenarios:

- Single-package: Dependencies are read directly from the root level
- Workspaces: Dependencies are read from each importer in the `importers` section

## Known limitations

1. **Local dependencies are skipped**: Packages referenced with `file:` or `link:` prefixes are not included in detection as they represent local packages rather than external dependencies. In the case of `link` dependencies that refer to a folder with a `package.json` file, the component may be detected by the `NpmComponentDetector` if the folder is inside the scan path.

   Example of ignored dependencies:
   ```yaml
   dependencies:
     '@learningclient/common': link:../common
     file:./projects/gmc-bootstrapper.tgz
   ```

2. **HTTP/HTTPS dependencies**: In version 9, dependencies referenced via `http:` or `https:` protocols are also skipped as they are treated similarly to local dependencies

3. **Lockfile version support**: Only versions 5, 6, and 9 are supported. If an unsupported version is detected, the file will be skipped and a warning will be logged

4. **Version 9 dev dependency detection**: Lockfile version 9 removed the metadata that explicitly marks packages as dev dependencies. The detector relies on the dependency tree structure to determine dev dependency status, which may be less accurate in complex scenarios

5. **Pnpm dependency path complexity**: Pnpm uses specialized dependency paths that include peer dependency information and other metadata. While the detector handles standard cases, highly complex dependency scenarios with multiple peer dependencies may not be perfectly represented

6. **Automatic root dependency calculation required**: The detector sets `NeedsAutomaticRootDependencyCalculation = true`, indicating that the orchestrator must perform additional analysis to determine root-level dependencies
